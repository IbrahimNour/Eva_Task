import { __awaiter } from "tslib";
import { Component, EventEmitter, Inject, Input, Optional, Output, QueryList, ViewChildren } from '@angular/core';
import { CodeInputComponentConfigToken, defaultComponentConfig } from './code-input.component.config';
var InputState;
(function (InputState) {
    InputState[InputState["ready"] = 0] = "ready";
    InputState[InputState["reset"] = 1] = "reset";
})(InputState || (InputState = {}));
export class CodeInputComponent {
    constructor(config) {
        /** @deprecated Use isCharsCode prop instead. */
        this.isNonDigitsCode = false;
        this.codeChanged = new EventEmitter();
        this.codeCompleted = new EventEmitter();
        this.inputs = [];
        this.inputsStates = [];
        this.state = {
            isFocusingAfterAppearingCompleted: false,
            isInitialFocusFieldEnabled: false
        };
        Object.assign(this, defaultComponentConfig);
        if (!config) {
            return;
        }
        // filtering for only valid config props
        for (const prop in config) {
            if (!config.hasOwnProperty(prop)) {
                continue;
            }
            if (!defaultComponentConfig.hasOwnProperty(prop)) {
                continue;
            }
            // @ts-ignore
            this[prop] = config[prop];
        }
    }
    /**
     * Life cycle
     */
    ngOnInit() {
        // defining internal code length prop for skipping external prop updates
        this._codeLength = this.codeLength;
        this.placeholders = Array(this._codeLength).fill(1);
        this.state.isInitialFocusFieldEnabled = !this.isEmpty(this.initialFocusField);
    }
    ngAfterViewInit() {
        this.inputsList.forEach((item) => {
            this.inputs.push(item.nativeElement);
            this.inputsStates.push(InputState.ready);
        });
        // the @Input code might have value. Checking
        this.onInputCodeChanges();
    }
    ngAfterViewChecked() {
        this.focusOnInputAfterAppearing();
    }
    ngOnChanges(changes) {
        if (changes.code) {
            this.onInputCodeChanges();
        }
    }
    /**
     * Methods
     */
    reset(isChangesEmitting = false) {
        // resetting the code to its initial value or to an empty value
        this.onInputCodeChanges();
        if (this.state.isInitialFocusFieldEnabled) {
            // tslint:disable-next-line:no-non-null-assertion
            this.focusOnField(this.initialFocusField);
        }
        if (isChangesEmitting) {
            this.emitChanges();
        }
    }
    focusOnField(index) {
        if (index >= this._codeLength) {
            throw new Error('The index of the focusing input box should be less than the codeLength.');
        }
        this.inputs[index].focus();
    }
    onClick(e) {
        // handle click events only if the the prop is enabled
        if (!this.isFocusingOnLastByClickIfFilled) {
            return;
        }
        const target = e.target;
        const last = this.inputs[this._codeLength - 1];
        // already focused
        if (target === last) {
            return;
        }
        // check filling
        const isFilled = this.getCurrentFilledCode().length >= this._codeLength;
        if (!isFilled) {
            return;
        }
        // focusing on the last input if is filled
        setTimeout(() => last.focus());
    }
    onInput(e, i) {
        const target = e.target;
        const value = e.data || target.value;
        if (this.isEmpty(value)) {
            return;
        }
        // only digits are allowed if isCharsCode flag is absent/false
        if (!this.canInputValue(value)) {
            e.preventDefault();
            e.stopPropagation();
            this.setInputValue(target, null);
            this.setStateForInput(target, InputState.reset);
            return;
        }
        const values = value.toString().trim().split('');
        for (let j = 0; j < values.length; j++) {
            const index = j + i;
            if (index > this._codeLength - 1) {
                break;
            }
            this.setInputValue(this.inputs[index], values[j]);
        }
        this.emitChanges();
        const next = i + values.length;
        if (next > this._codeLength - 1) {
            target.blur();
            return;
        }
        this.inputs[next].focus();
    }
    onPaste(e, i) {
        e.preventDefault();
        e.stopPropagation();
        const data = e.clipboardData ? e.clipboardData.getData('text').trim() : undefined;
        if (this.isEmpty(data)) {
            return;
        }
        // Convert paste text into iterable
        // tslint:disable-next-line:no-non-null-assertion
        const values = data.split('');
        let valIndex = 0;
        for (let j = i; j < this.inputs.length; j++) {
            // The values end is reached. Loop exit
            if (valIndex === values.length) {
                break;
            }
            const input = this.inputs[j];
            const val = values[valIndex];
            // Cancel the loop when a value cannot be used
            if (!this.canInputValue(val)) {
                this.setInputValue(input, null);
                this.setStateForInput(input, InputState.reset);
                return;
            }
            this.setInputValue(input, val.toString());
            valIndex++;
        }
        this.inputs[i].blur();
        this.emitChanges();
    }
    onKeydown(e, i) {
        return __awaiter(this, void 0, void 0, function* () {
            const target = e.target;
            const isTargetEmpty = this.isEmpty(target.value);
            const prev = i - 1;
            // processing only backspace events
            const isBackspaceKey = yield this.isBackspaceKey(e);
            if (!isBackspaceKey) {
                return;
            }
            e.preventDefault();
            this.setInputValue(target, null);
            if (!isTargetEmpty) {
                this.emitChanges();
            }
            if (prev < 0) {
                return;
            }
            if (isTargetEmpty || this.isPrevFocusableAfterClearing) {
                this.inputs[prev].focus();
            }
        });
    }
    onInputCodeChanges() {
        if (!this.inputs.length) {
            return;
        }
        if (this.isEmpty(this.code)) {
            this.inputs.forEach((input) => {
                this.setInputValue(input, null);
            });
            return;
        }
        // tslint:disable-next-line:no-non-null-assertion
        const chars = this.code.toString().trim().split('');
        // checking if all the values are correct
        let isAllCharsAreAllowed = true;
        for (const char of chars) {
            if (!this.canInputValue(char)) {
                isAllCharsAreAllowed = false;
                break;
            }
        }
        this.inputs.forEach((input, index) => {
            const value = isAllCharsAreAllowed ? chars[index] : null;
            this.setInputValue(input, value);
        });
    }
    focusOnInputAfterAppearing() {
        if (!this.state.isInitialFocusFieldEnabled) {
            return;
        }
        if (this.state.isFocusingAfterAppearingCompleted) {
            return;
        }
        // tslint:disable-next-line:no-non-null-assertion
        this.focusOnField(this.initialFocusField);
        // tslint:disable-next-line:no-non-null-assertion
        this.state.isFocusingAfterAppearingCompleted = document.activeElement === this.inputs[this.initialFocusField];
    }
    emitChanges() {
        setTimeout(() => this.emitCode(), 50);
    }
    emitCode() {
        const code = this.getCurrentFilledCode();
        this.codeChanged.emit(code);
        if (code.length >= this._codeLength) {
            this.codeCompleted.emit(code);
        }
    }
    getCurrentFilledCode() {
        let code = '';
        for (const input of this.inputs) {
            if (!this.isEmpty(input.value)) {
                code += input.value;
            }
        }
        return code;
    }
    isBackspaceKey(e) {
        const isBackspace = (e.key && e.key.toLowerCase() === 'backspace') || (e.keyCode && e.keyCode === 8);
        if (isBackspace) {
            return Promise.resolve(true);
        }
        // process only key with placeholder keycode on android devices
        if (!e.keyCode || e.keyCode !== 229) {
            return Promise.resolve(false);
        }
        return new Promise((resolve) => {
            setTimeout(() => {
                const input = e.target;
                const isReset = this.getStateForInput(input) === InputState.reset;
                if (isReset) {
                    this.setStateForInput(input, InputState.ready);
                }
                // if backspace key pressed the caret will have position 0 (for single value field)
                resolve(input.selectionStart === 0 && !isReset);
            });
        });
    }
    setInputValue(input, value) {
        const isEmpty = this.isEmpty(value);
        const valueClassCSS = 'has-value';
        const emptyClassCSS = 'empty';
        if (isEmpty) {
            input.value = '';
            input.classList.remove(valueClassCSS);
            // tslint:disable-next-line:no-non-null-assertion
            input.parentElement.classList.add(emptyClassCSS);
        }
        else {
            input.value = value;
            input.classList.add(valueClassCSS);
            // tslint:disable-next-line:no-non-null-assertion
            input.parentElement.classList.remove(emptyClassCSS);
        }
    }
    canInputValue(value) {
        if (this.isEmpty(value)) {
            return false;
        }
        const isDigitsValue = /^[0-9]+$/.test(value.toString());
        return isDigitsValue || (this.isCharsCode || this.isNonDigitsCode);
    }
    setStateForInput(input, state) {
        const index = this.inputs.indexOf(input);
        if (index < 0) {
            return;
        }
        this.inputsStates[index] = state;
    }
    getStateForInput(input) {
        const index = this.inputs.indexOf(input);
        return this.inputsStates[index];
    }
    isEmpty(value) {
        return value === null || value === undefined || !value.toString().length;
    }
}
CodeInputComponent.decorators = [
    { type: Component, args: [{
                // tslint:disable-next-line:component-selector
                selector: 'code-input',
                template: "<span *ngFor=\"let holder of placeholders; index as i\"\n      [class.code-hidden]=\"isCodeHidden\">\n  <input #input\n         (click)=\"onClick($event)\"\n         (paste)=\"onPaste($event, i)\"\n         (input)=\"onInput($event, i)\"\n         (keydown)=\"onKeydown($event, i)\"\n         [type]=\"inputType\"\n         [disabled]=\"disabled\"\n         autocomplete=\"one-time-code\"/>\n</span>\n",
                styles: [":host{--text-security-type:disc;--item-spacing:4px;--item-height:4.375em;--item-border:1px solid #ddd;--item-border-bottom:1px solid #ddd;--item-border-has-value:1px solid #ddd;--item-border-bottom-has-value:1px solid #ddd;--item-border-focused:1px solid #ddd;--item-border-bottom-focused:1px solid #ddd;--item-shadow-focused:0px 1px 5px #ddd;--item-border-radius:5px;--item-background:transparent;--color:#171516;display:flex;transform:translateZ(0);font-size:inherit;color:var(--color)}:host span{display:block;flex:1;padding-right:var(--item-spacing)}:host span:first-child{padding-left:var(--item-spacing)}:host span.code-hidden input{text-security:var(--text-security-type);-webkit-text-security:var(--text-security-type);-moz-text-security:var(--text-security-type)}:host input{width:100%;height:var(--item-height);color:inherit;background:var(--item-background);text-align:center;font-size:inherit;border:var(--item-border);border-bottom:var(--item-border-bottom);border-radius:var(--item-border-radius);-webkit-appearance:none;transform:translateZ(0);-webkit-transform:translateZ(0);outline:none}:host input.has-value{border:var(--item-border-has-value);border-bottom:var(--item-border-bottom-has-value)}:host input:focus{border:var(--item-border-focused);border-bottom:var(--item-border-bottom-focused);box-shadow:var(--item-shadow-focused)}"]
            },] }
];
/** @nocollapse */
CodeInputComponent.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [CodeInputComponentConfigToken,] }] }
];
CodeInputComponent.propDecorators = {
    inputsList: [{ type: ViewChildren, args: ['input',] }],
    codeLength: [{ type: Input }],
    inputType: [{ type: Input }],
    initialFocusField: [{ type: Input }],
    isNonDigitsCode: [{ type: Input }],
    isCharsCode: [{ type: Input }],
    isCodeHidden: [{ type: Input }],
    isPrevFocusableAfterClearing: [{ type: Input }],
    isFocusingOnLastByClickIfFilled: [{ type: Input }],
    code: [{ type: Input }],
    disabled: [{ type: Input }],
    codeChanged: [{ type: Output }],
    codeCompleted: [{ type: Output }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29kZS1pbnB1dC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9hbmd1bGFyLWNvZGUtaW5wdXQvc3JjL2xpYi9jb2RlLWlucHV0LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUdMLFNBQVMsRUFFVCxZQUFZLEVBQ1osTUFBTSxFQUNOLEtBQUssRUFHTCxRQUFRLEVBQ1IsTUFBTSxFQUNOLFNBQVMsRUFFVCxZQUFZLEVBQ2IsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUVMLDZCQUE2QixFQUM3QixzQkFBc0IsRUFDdkIsTUFBTSwrQkFBK0IsQ0FBQztBQUV2QyxJQUFLLFVBR0o7QUFIRCxXQUFLLFVBQVU7SUFDYiw2Q0FBUyxDQUFBO0lBQ1QsNkNBQVMsQ0FBQTtBQUNYLENBQUMsRUFISSxVQUFVLEtBQVYsVUFBVSxRQUdkO0FBUUQsTUFBTSxPQUFPLGtCQUFrQjtJQStCN0IsWUFBK0QsTUFBaUM7UUF4QmhHLGdEQUFnRDtRQUN2QyxvQkFBZSxHQUFHLEtBQUssQ0FBQztRQVFkLGdCQUFXLEdBQUcsSUFBSSxZQUFZLEVBQVUsQ0FBQztRQUN6QyxrQkFBYSxHQUFHLElBQUksWUFBWSxFQUFVLENBQUM7UUFJdEQsV0FBTSxHQUF1QixFQUFFLENBQUM7UUFDaEMsaUJBQVksR0FBaUIsRUFBRSxDQUFDO1FBSWhDLFVBQUssR0FBRztZQUNkLGlDQUFpQyxFQUFFLEtBQUs7WUFDeEMsMEJBQTBCLEVBQUUsS0FBSztTQUNsQyxDQUFDO1FBR0EsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsc0JBQXNCLENBQUMsQ0FBQztRQUU1QyxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ1gsT0FBTztTQUNSO1FBRUQsd0NBQXdDO1FBQ3hDLEtBQUssTUFBTSxJQUFJLElBQUksTUFBTSxFQUFFO1lBQ3pCLElBQUksQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUNoQyxTQUFTO2FBQ1Y7WUFFRCxJQUFJLENBQUMsc0JBQXNCLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUNoRCxTQUFTO2FBQ1Y7WUFFRCxhQUFhO1lBQ2IsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUMzQjtJQUNILENBQUM7SUFFRDs7T0FFRztJQUVILFFBQVE7UUFDTix3RUFBd0U7UUFDeEUsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDO1FBQ25DLElBQUksQ0FBQyxZQUFZLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDcEQsSUFBSSxDQUFDLEtBQUssQ0FBQywwQkFBMEIsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUM7SUFDaEYsQ0FBQztJQUVELGVBQWU7UUFDYixJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFO1lBQy9CLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztZQUNyQyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDM0MsQ0FBQyxDQUFDLENBQUM7UUFFSCw2Q0FBNkM7UUFDN0MsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7SUFDNUIsQ0FBQztJQUVELGtCQUFrQjtRQUNoQixJQUFJLENBQUMsMEJBQTBCLEVBQUUsQ0FBQztJQUNwQyxDQUFDO0lBRUQsV0FBVyxDQUFDLE9BQXNCO1FBQ2hDLElBQUksT0FBTyxDQUFDLElBQUksRUFBRTtZQUNoQixJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztTQUMzQjtJQUNILENBQUM7SUFFRDs7T0FFRztJQUVILEtBQUssQ0FBQyxpQkFBaUIsR0FBRyxLQUFLO1FBQzdCLCtEQUErRDtRQUMvRCxJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztRQUUxQixJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsMEJBQTBCLEVBQUU7WUFDekMsaURBQWlEO1lBQ2pELElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLGlCQUFrQixDQUFDLENBQUM7U0FDNUM7UUFFRCxJQUFJLGlCQUFpQixFQUFFO1lBQ3JCLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztTQUNwQjtJQUNILENBQUM7SUFFRCxZQUFZLENBQUMsS0FBYTtRQUN4QixJQUFJLEtBQUssSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFO1lBQzdCLE1BQU0sSUFBSSxLQUFLLENBQUMseUVBQXlFLENBQUMsQ0FBQztTQUM1RjtRQUVELElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDN0IsQ0FBQztJQUVELE9BQU8sQ0FBQyxDQUFNO1FBQ1osc0RBQXNEO1FBQ3RELElBQUksQ0FBQyxJQUFJLENBQUMsK0JBQStCLEVBQUU7WUFDekMsT0FBTztTQUNSO1FBRUQsTUFBTSxNQUFNLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQztRQUN4QixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDL0Msa0JBQWtCO1FBQ2xCLElBQUksTUFBTSxLQUFLLElBQUksRUFBRTtZQUNuQixPQUFPO1NBQ1I7UUFFRCxnQkFBZ0I7UUFDaEIsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUM7UUFDeEUsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNiLE9BQU87U0FDUjtRQUVELDBDQUEwQztRQUMxQyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7SUFDakMsQ0FBQztJQUVELE9BQU8sQ0FBQyxDQUFNLEVBQUUsQ0FBUztRQUN2QixNQUFNLE1BQU0sR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDO1FBQ3hCLE1BQU0sS0FBSyxHQUFHLENBQUMsQ0FBQyxJQUFJLElBQUksTUFBTSxDQUFDLEtBQUssQ0FBQztRQUVyQyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDdkIsT0FBTztTQUNSO1FBRUQsOERBQThEO1FBQzlELElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQzlCLENBQUMsQ0FBQyxjQUFjLEVBQUUsQ0FBQztZQUNuQixDQUFDLENBQUMsZUFBZSxFQUFFLENBQUM7WUFDcEIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDakMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDaEQsT0FBTztTQUNSO1FBRUQsTUFBTSxNQUFNLEdBQUcsS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDLElBQUksRUFBRSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNqRCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUN0QyxNQUFNLEtBQUssR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3BCLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxXQUFXLEdBQUcsQ0FBQyxFQUFFO2dCQUNoQyxNQUFNO2FBQ1A7WUFFRCxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDbkQ7UUFDRCxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7UUFFbkIsTUFBTSxJQUFJLEdBQUcsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUM7UUFDL0IsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLFdBQVcsR0FBRyxDQUFDLEVBQUU7WUFDL0IsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ2QsT0FBTztTQUNSO1FBRUQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUM1QixDQUFDO0lBRUQsT0FBTyxDQUFDLENBQWlCLEVBQUUsQ0FBUztRQUNsQyxDQUFDLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDbkIsQ0FBQyxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBRXBCLE1BQU0sSUFBSSxHQUFHLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7UUFFbEYsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ3RCLE9BQU87U0FDUjtRQUVELG1DQUFtQztRQUNuQyxpREFBaUQ7UUFDakQsTUFBTSxNQUFNLEdBQUcsSUFBSyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUMvQixJQUFJLFFBQVEsR0FBRyxDQUFDLENBQUM7UUFFakIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQzNDLHVDQUF1QztZQUN2QyxJQUFJLFFBQVEsS0FBSyxNQUFNLENBQUMsTUFBTSxFQUFFO2dCQUM5QixNQUFNO2FBQ1A7WUFFRCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzdCLE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUU3Qiw4Q0FBOEM7WUFDOUMsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLEVBQUU7Z0JBQzVCLElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUNoQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxFQUFFLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDL0MsT0FBTzthQUNSO1lBRUQsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7WUFDMUMsUUFBUSxFQUFFLENBQUM7U0FDWjtRQUVELElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDdEIsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ3JCLENBQUM7SUFFSyxTQUFTLENBQUMsQ0FBTSxFQUFFLENBQVM7O1lBQy9CLE1BQU0sTUFBTSxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUM7WUFDeEIsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDakQsTUFBTSxJQUFJLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUVuQixtQ0FBbUM7WUFDbkMsTUFBTSxjQUFjLEdBQUcsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3BELElBQUksQ0FBQyxjQUFjLEVBQUU7Z0JBQ25CLE9BQU87YUFDUjtZQUVELENBQUMsQ0FBQyxjQUFjLEVBQUUsQ0FBQztZQUVuQixJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztZQUNqQyxJQUFJLENBQUMsYUFBYSxFQUFFO2dCQUNsQixJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7YUFDcEI7WUFFRCxJQUFJLElBQUksR0FBRyxDQUFDLEVBQUU7Z0JBQ1osT0FBTzthQUNSO1lBRUQsSUFBSSxhQUFhLElBQUksSUFBSSxDQUFDLDRCQUE0QixFQUFFO2dCQUN0RCxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDO2FBQzNCO1FBQ0gsQ0FBQztLQUFBO0lBRU8sa0JBQWtCO1FBQ3hCLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRTtZQUN2QixPQUFPO1NBQ1I7UUFFRCxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQzNCLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBdUIsRUFBRSxFQUFFO2dCQUM5QyxJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztZQUNsQyxDQUFDLENBQUMsQ0FBQztZQUNILE9BQU87U0FDUjtRQUVELGlEQUFpRDtRQUNqRCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsSUFBSyxDQUFDLFFBQVEsRUFBRSxDQUFDLElBQUksRUFBRSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNyRCx5Q0FBeUM7UUFDekMsSUFBSSxvQkFBb0IsR0FBRyxJQUFJLENBQUM7UUFDaEMsS0FBSyxNQUFNLElBQUksSUFBSSxLQUFLLEVBQUU7WUFDeEIsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLEVBQUU7Z0JBQzdCLG9CQUFvQixHQUFHLEtBQUssQ0FBQztnQkFDN0IsTUFBTTthQUNQO1NBQ0Y7UUFFRCxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEtBQXVCLEVBQUUsS0FBYSxFQUFFLEVBQUU7WUFDN0QsTUFBTSxLQUFLLEdBQUcsb0JBQW9CLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQ3pELElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ25DLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVPLDBCQUEwQjtRQUNoQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQywwQkFBMEIsRUFBRTtZQUMxQyxPQUFPO1NBQ1I7UUFFRCxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsaUNBQWlDLEVBQUU7WUFDaEQsT0FBTztTQUNSO1FBRUQsaURBQWlEO1FBQ2pELElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLGlCQUFrQixDQUFDLENBQUM7UUFDM0MsaURBQWlEO1FBQ2pELElBQUksQ0FBQyxLQUFLLENBQUMsaUNBQWlDLEdBQUcsUUFBUSxDQUFDLGFBQWEsS0FBSyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxpQkFBa0IsQ0FBQyxDQUFDO0lBQ2pILENBQUM7SUFFTyxXQUFXO1FBQ2pCLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUVPLFFBQVE7UUFDZCxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztRQUV6QyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUU1QixJQUFJLElBQUksQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUNuQyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUMvQjtJQUNILENBQUM7SUFFTyxvQkFBb0I7UUFDMUIsSUFBSSxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBRWQsS0FBSyxNQUFNLEtBQUssSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQy9CLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDOUIsSUFBSSxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUM7YUFDckI7U0FDRjtRQUVELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVPLGNBQWMsQ0FBQyxDQUFNO1FBQzNCLE1BQU0sV0FBVyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxLQUFLLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLE9BQU8sSUFBSSxDQUFDLENBQUMsT0FBTyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBQ3JHLElBQUksV0FBVyxFQUFFO1lBQ2YsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQzlCO1FBRUQsK0RBQStEO1FBQy9ELElBQUksQ0FBQyxDQUFDLENBQUMsT0FBTyxJQUFJLENBQUMsQ0FBQyxPQUFPLEtBQUssR0FBRyxFQUFFO1lBQ25DLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUMvQjtRQUVELE9BQU8sSUFBSSxPQUFPLENBQVUsQ0FBQyxPQUFPLEVBQUUsRUFBRTtZQUN0QyxVQUFVLENBQUMsR0FBRyxFQUFFO2dCQUNkLE1BQU0sS0FBSyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUM7Z0JBQ3ZCLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsS0FBSyxVQUFVLENBQUMsS0FBSyxDQUFDO2dCQUNsRSxJQUFJLE9BQU8sRUFBRTtvQkFDWCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxFQUFFLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztpQkFDaEQ7Z0JBQ0QsbUZBQW1GO2dCQUNuRixPQUFPLENBQUMsS0FBSyxDQUFDLGNBQWMsS0FBSyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNsRCxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVPLGFBQWEsQ0FBQyxLQUF1QixFQUFFLEtBQVU7UUFDdkQsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNwQyxNQUFNLGFBQWEsR0FBRyxXQUFXLENBQUM7UUFDbEMsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDO1FBQzlCLElBQUksT0FBTyxFQUFFO1lBQ1gsS0FBSyxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUM7WUFDakIsS0FBSyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDdEMsaURBQWlEO1lBQ2pELEtBQUssQ0FBQyxhQUFjLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQztTQUNuRDthQUNJO1lBQ0gsS0FBSyxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7WUFDcEIsS0FBSyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDbkMsaURBQWlEO1lBQ2pELEtBQUssQ0FBQyxhQUFjLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQztTQUN0RDtJQUNILENBQUM7SUFFTyxhQUFhLENBQUMsS0FBVTtRQUM5QixJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDdkIsT0FBTyxLQUFLLENBQUM7U0FDZDtRQUVELE1BQU0sYUFBYSxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFDeEQsT0FBTyxhQUFhLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxJQUFJLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztJQUNyRSxDQUFDO0lBRU8sZ0JBQWdCLENBQUMsS0FBdUIsRUFBRSxLQUFpQjtRQUNqRSxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN6QyxJQUFJLEtBQUssR0FBRyxDQUFDLEVBQUU7WUFDYixPQUFPO1NBQ1I7UUFFRCxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxHQUFHLEtBQUssQ0FBQztJQUNuQyxDQUFDO0lBRU8sZ0JBQWdCLENBQUMsS0FBdUI7UUFDOUMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDekMsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ2xDLENBQUM7SUFFTyxPQUFPLENBQUMsS0FBVTtRQUN4QixPQUFRLEtBQUssS0FBSyxJQUFJLElBQUksS0FBSyxLQUFLLFNBQVMsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQyxNQUFNLENBQUM7SUFDNUUsQ0FBQzs7O1lBM1hGLFNBQVMsU0FBQztnQkFDVCw4Q0FBOEM7Z0JBQzlDLFFBQVEsRUFBRSxZQUFZO2dCQUN0Qiw2WkFBd0M7O2FBRXpDOzs7OzRDQWdDYyxRQUFRLFlBQUksTUFBTSxTQUFDLDZCQUE2Qjs7O3lCQTdCNUQsWUFBWSxTQUFDLE9BQU87eUJBRXBCLEtBQUs7d0JBQ0wsS0FBSztnQ0FDTCxLQUFLOzhCQUVMLEtBQUs7MEJBQ0wsS0FBSzsyQkFDTCxLQUFLOzJDQUNMLEtBQUs7OENBQ0wsS0FBSzttQkFDTCxLQUFLO3VCQUNMLEtBQUs7MEJBRUwsTUFBTTs0QkFDTixNQUFNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQWZ0ZXJWaWV3Q2hlY2tlZCxcbiAgQWZ0ZXJWaWV3SW5pdCxcbiAgQ29tcG9uZW50LFxuICBFbGVtZW50UmVmLFxuICBFdmVudEVtaXR0ZXIsXG4gIEluamVjdCxcbiAgSW5wdXQsXG4gIE9uQ2hhbmdlcyxcbiAgT25Jbml0LFxuICBPcHRpb25hbCxcbiAgT3V0cHV0LFxuICBRdWVyeUxpc3QsXG4gIFNpbXBsZUNoYW5nZXMsXG4gIFZpZXdDaGlsZHJlblxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIENvZGVJbnB1dENvbXBvbmVudENvbmZpZyxcbiAgQ29kZUlucHV0Q29tcG9uZW50Q29uZmlnVG9rZW4sXG4gIGRlZmF1bHRDb21wb25lbnRDb25maWdcbn0gZnJvbSAnLi9jb2RlLWlucHV0LmNvbXBvbmVudC5jb25maWcnO1xuXG5lbnVtIElucHV0U3RhdGUge1xuICByZWFkeSA9IDAsXG4gIHJlc2V0ID0gMVxufVxuXG5AQ29tcG9uZW50KHtcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOmNvbXBvbmVudC1zZWxlY3RvclxuICBzZWxlY3RvcjogJ2NvZGUtaW5wdXQnLFxuICB0ZW1wbGF0ZVVybDogJ2NvZGUtaW5wdXQuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9jb2RlLWlucHV0LmNvbXBvbmVudC5zY3NzJ11cbn0pXG5leHBvcnQgY2xhc3MgQ29kZUlucHV0Q29tcG9uZW50IGltcGxlbWVudHMgQWZ0ZXJWaWV3SW5pdCwgT25Jbml0LCBPbkNoYW5nZXMsIEFmdGVyVmlld0NoZWNrZWQsIENvZGVJbnB1dENvbXBvbmVudENvbmZpZyB7XG5cbiAgQFZpZXdDaGlsZHJlbignaW5wdXQnKSBpbnB1dHNMaXN0ICE6IFF1ZXJ5TGlzdDxFbGVtZW50UmVmPjtcblxuICBASW5wdXQoKSBjb2RlTGVuZ3RoICE6IG51bWJlcjtcbiAgQElucHV0KCkgaW5wdXRUeXBlICE6IHN0cmluZztcbiAgQElucHV0KCkgaW5pdGlhbEZvY3VzRmllbGQ/OiBudW1iZXI7XG4gIC8qKiBAZGVwcmVjYXRlZCBVc2UgaXNDaGFyc0NvZGUgcHJvcCBpbnN0ZWFkLiAqL1xuICBASW5wdXQoKSBpc05vbkRpZ2l0c0NvZGUgPSBmYWxzZTtcbiAgQElucHV0KCkgaXNDaGFyc0NvZGUgITogYm9vbGVhbjtcbiAgQElucHV0KCkgaXNDb2RlSGlkZGVuICE6IGJvb2xlYW47XG4gIEBJbnB1dCgpIGlzUHJldkZvY3VzYWJsZUFmdGVyQ2xlYXJpbmcgITogYm9vbGVhbjtcbiAgQElucHV0KCkgaXNGb2N1c2luZ09uTGFzdEJ5Q2xpY2tJZkZpbGxlZCAhOiBib29sZWFuO1xuICBASW5wdXQoKSBjb2RlID86IHN0cmluZyB8IG51bWJlcjtcbiAgQElucHV0KCkgZGlzYWJsZWQgITogYm9vbGVhbjtcblxuICBAT3V0cHV0KCkgcmVhZG9ubHkgY29kZUNoYW5nZWQgPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZz4oKTtcbiAgQE91dHB1dCgpIHJlYWRvbmx5IGNvZGVDb21wbGV0ZWQgPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZz4oKTtcblxuICBwdWJsaWMgcGxhY2Vob2xkZXJzICE6IG51bWJlcltdO1xuXG4gIHByaXZhdGUgaW5wdXRzOiBIVE1MSW5wdXRFbGVtZW50W10gPSBbXTtcbiAgcHJpdmF0ZSBpbnB1dHNTdGF0ZXM6IElucHV0U3RhdGVbXSA9IFtdO1xuXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTp2YXJpYWJsZS1uYW1lXG4gIHByaXZhdGUgX2NvZGVMZW5ndGggITogbnVtYmVyO1xuICBwcml2YXRlIHN0YXRlID0ge1xuICAgIGlzRm9jdXNpbmdBZnRlckFwcGVhcmluZ0NvbXBsZXRlZDogZmFsc2UsXG4gICAgaXNJbml0aWFsRm9jdXNGaWVsZEVuYWJsZWQ6IGZhbHNlXG4gIH07XG5cbiAgY29uc3RydWN0b3IoQE9wdGlvbmFsKCkgQEluamVjdChDb2RlSW5wdXRDb21wb25lbnRDb25maWdUb2tlbikgY29uZmlnPzogQ29kZUlucHV0Q29tcG9uZW50Q29uZmlnKSB7XG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLCBkZWZhdWx0Q29tcG9uZW50Q29uZmlnKTtcblxuICAgIGlmICghY29uZmlnKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gZmlsdGVyaW5nIGZvciBvbmx5IHZhbGlkIGNvbmZpZyBwcm9wc1xuICAgIGZvciAoY29uc3QgcHJvcCBpbiBjb25maWcpIHtcbiAgICAgIGlmICghY29uZmlnLmhhc093blByb3BlcnR5KHByb3ApKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBpZiAoIWRlZmF1bHRDb21wb25lbnRDb25maWcuaGFzT3duUHJvcGVydHkocHJvcCkpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgIHRoaXNbcHJvcF0gPSBjb25maWdbcHJvcF07XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIExpZmUgY3ljbGVcbiAgICovXG5cbiAgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgLy8gZGVmaW5pbmcgaW50ZXJuYWwgY29kZSBsZW5ndGggcHJvcCBmb3Igc2tpcHBpbmcgZXh0ZXJuYWwgcHJvcCB1cGRhdGVzXG4gICAgdGhpcy5fY29kZUxlbmd0aCA9IHRoaXMuY29kZUxlbmd0aDtcbiAgICB0aGlzLnBsYWNlaG9sZGVycyA9IEFycmF5KHRoaXMuX2NvZGVMZW5ndGgpLmZpbGwoMSk7XG4gICAgdGhpcy5zdGF0ZS5pc0luaXRpYWxGb2N1c0ZpZWxkRW5hYmxlZCA9ICF0aGlzLmlzRW1wdHkodGhpcy5pbml0aWFsRm9jdXNGaWVsZCk7XG4gIH1cblxuICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XG4gICAgdGhpcy5pbnB1dHNMaXN0LmZvckVhY2goKGl0ZW0pID0+IHtcbiAgICAgIHRoaXMuaW5wdXRzLnB1c2goaXRlbS5uYXRpdmVFbGVtZW50KTtcbiAgICAgIHRoaXMuaW5wdXRzU3RhdGVzLnB1c2goSW5wdXRTdGF0ZS5yZWFkeSk7XG4gICAgfSk7XG5cbiAgICAvLyB0aGUgQElucHV0IGNvZGUgbWlnaHQgaGF2ZSB2YWx1ZS4gQ2hlY2tpbmdcbiAgICB0aGlzLm9uSW5wdXRDb2RlQ2hhbmdlcygpO1xuICB9XG5cbiAgbmdBZnRlclZpZXdDaGVja2VkKCk6IHZvaWQge1xuICAgIHRoaXMuZm9jdXNPbklucHV0QWZ0ZXJBcHBlYXJpbmcoKTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcbiAgICBpZiAoY2hhbmdlcy5jb2RlKSB7XG4gICAgICB0aGlzLm9uSW5wdXRDb2RlQ2hhbmdlcygpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBNZXRob2RzXG4gICAqL1xuXG4gIHJlc2V0KGlzQ2hhbmdlc0VtaXR0aW5nID0gZmFsc2UpOiB2b2lkIHtcbiAgICAvLyByZXNldHRpbmcgdGhlIGNvZGUgdG8gaXRzIGluaXRpYWwgdmFsdWUgb3IgdG8gYW4gZW1wdHkgdmFsdWVcbiAgICB0aGlzLm9uSW5wdXRDb2RlQ2hhbmdlcygpO1xuXG4gICAgaWYgKHRoaXMuc3RhdGUuaXNJbml0aWFsRm9jdXNGaWVsZEVuYWJsZWQpIHtcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICAgIHRoaXMuZm9jdXNPbkZpZWxkKHRoaXMuaW5pdGlhbEZvY3VzRmllbGQhKTtcbiAgICB9XG5cbiAgICBpZiAoaXNDaGFuZ2VzRW1pdHRpbmcpIHtcbiAgICAgIHRoaXMuZW1pdENoYW5nZXMoKTtcbiAgICB9XG4gIH1cblxuICBmb2N1c09uRmllbGQoaW5kZXg6IG51bWJlcik6IHZvaWQge1xuICAgIGlmIChpbmRleCA+PSB0aGlzLl9jb2RlTGVuZ3RoKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBpbmRleCBvZiB0aGUgZm9jdXNpbmcgaW5wdXQgYm94IHNob3VsZCBiZSBsZXNzIHRoYW4gdGhlIGNvZGVMZW5ndGguJyk7XG4gICAgfVxuXG4gICAgdGhpcy5pbnB1dHNbaW5kZXhdLmZvY3VzKCk7XG4gIH1cblxuICBvbkNsaWNrKGU6IGFueSk6IHZvaWQge1xuICAgIC8vIGhhbmRsZSBjbGljayBldmVudHMgb25seSBpZiB0aGUgdGhlIHByb3AgaXMgZW5hYmxlZFxuICAgIGlmICghdGhpcy5pc0ZvY3VzaW5nT25MYXN0QnlDbGlja0lmRmlsbGVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgdGFyZ2V0ID0gZS50YXJnZXQ7XG4gICAgY29uc3QgbGFzdCA9IHRoaXMuaW5wdXRzW3RoaXMuX2NvZGVMZW5ndGggLSAxXTtcbiAgICAvLyBhbHJlYWR5IGZvY3VzZWRcbiAgICBpZiAodGFyZ2V0ID09PSBsYXN0KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gY2hlY2sgZmlsbGluZ1xuICAgIGNvbnN0IGlzRmlsbGVkID0gdGhpcy5nZXRDdXJyZW50RmlsbGVkQ29kZSgpLmxlbmd0aCA+PSB0aGlzLl9jb2RlTGVuZ3RoO1xuICAgIGlmICghaXNGaWxsZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBmb2N1c2luZyBvbiB0aGUgbGFzdCBpbnB1dCBpZiBpcyBmaWxsZWRcbiAgICBzZXRUaW1lb3V0KCgpID0+IGxhc3QuZm9jdXMoKSk7XG4gIH1cblxuICBvbklucHV0KGU6IGFueSwgaTogbnVtYmVyKTogdm9pZCB7XG4gICAgY29uc3QgdGFyZ2V0ID0gZS50YXJnZXQ7XG4gICAgY29uc3QgdmFsdWUgPSBlLmRhdGEgfHwgdGFyZ2V0LnZhbHVlO1xuXG4gICAgaWYgKHRoaXMuaXNFbXB0eSh2YWx1ZSkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBvbmx5IGRpZ2l0cyBhcmUgYWxsb3dlZCBpZiBpc0NoYXJzQ29kZSBmbGFnIGlzIGFic2VudC9mYWxzZVxuICAgIGlmICghdGhpcy5jYW5JbnB1dFZhbHVlKHZhbHVlKSkge1xuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgIHRoaXMuc2V0SW5wdXRWYWx1ZSh0YXJnZXQsIG51bGwpO1xuICAgICAgdGhpcy5zZXRTdGF0ZUZvcklucHV0KHRhcmdldCwgSW5wdXRTdGF0ZS5yZXNldCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgdmFsdWVzID0gdmFsdWUudG9TdHJpbmcoKS50cmltKCkuc3BsaXQoJycpO1xuICAgIGZvciAobGV0IGogPSAwOyBqIDwgdmFsdWVzLmxlbmd0aDsgaisrKSB7XG4gICAgICBjb25zdCBpbmRleCA9IGogKyBpO1xuICAgICAgaWYgKGluZGV4ID4gdGhpcy5fY29kZUxlbmd0aCAtIDEpIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuc2V0SW5wdXRWYWx1ZSh0aGlzLmlucHV0c1tpbmRleF0sIHZhbHVlc1tqXSk7XG4gICAgfVxuICAgIHRoaXMuZW1pdENoYW5nZXMoKTtcblxuICAgIGNvbnN0IG5leHQgPSBpICsgdmFsdWVzLmxlbmd0aDtcbiAgICBpZiAobmV4dCA+IHRoaXMuX2NvZGVMZW5ndGggLSAxKSB7XG4gICAgICB0YXJnZXQuYmx1cigpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMuaW5wdXRzW25leHRdLmZvY3VzKCk7XG4gIH1cblxuICBvblBhc3RlKGU6IENsaXBib2FyZEV2ZW50LCBpOiBudW1iZXIpOiB2b2lkIHtcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcblxuICAgIGNvbnN0IGRhdGEgPSBlLmNsaXBib2FyZERhdGEgPyBlLmNsaXBib2FyZERhdGEuZ2V0RGF0YSgndGV4dCcpLnRyaW0oKSA6IHVuZGVmaW5lZDtcblxuICAgIGlmICh0aGlzLmlzRW1wdHkoZGF0YSkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBDb252ZXJ0IHBhc3RlIHRleHQgaW50byBpdGVyYWJsZVxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICBjb25zdCB2YWx1ZXMgPSBkYXRhIS5zcGxpdCgnJyk7XG4gICAgbGV0IHZhbEluZGV4ID0gMDtcblxuICAgIGZvciAobGV0IGogPSBpOyBqIDwgdGhpcy5pbnB1dHMubGVuZ3RoOyBqKyspIHtcbiAgICAgIC8vIFRoZSB2YWx1ZXMgZW5kIGlzIHJlYWNoZWQuIExvb3AgZXhpdFxuICAgICAgaWYgKHZhbEluZGV4ID09PSB2YWx1ZXMubGVuZ3RoKSB7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBpbnB1dCA9IHRoaXMuaW5wdXRzW2pdO1xuICAgICAgY29uc3QgdmFsID0gdmFsdWVzW3ZhbEluZGV4XTtcblxuICAgICAgLy8gQ2FuY2VsIHRoZSBsb29wIHdoZW4gYSB2YWx1ZSBjYW5ub3QgYmUgdXNlZFxuICAgICAgaWYgKCF0aGlzLmNhbklucHV0VmFsdWUodmFsKSkge1xuICAgICAgICB0aGlzLnNldElucHV0VmFsdWUoaW5wdXQsIG51bGwpO1xuICAgICAgICB0aGlzLnNldFN0YXRlRm9ySW5wdXQoaW5wdXQsIElucHV0U3RhdGUucmVzZXQpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIHRoaXMuc2V0SW5wdXRWYWx1ZShpbnB1dCwgdmFsLnRvU3RyaW5nKCkpO1xuICAgICAgdmFsSW5kZXgrKztcbiAgICB9XG5cbiAgICB0aGlzLmlucHV0c1tpXS5ibHVyKCk7XG4gICAgdGhpcy5lbWl0Q2hhbmdlcygpO1xuICB9XG5cbiAgYXN5bmMgb25LZXlkb3duKGU6IGFueSwgaTogbnVtYmVyKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgdGFyZ2V0ID0gZS50YXJnZXQ7XG4gICAgY29uc3QgaXNUYXJnZXRFbXB0eSA9IHRoaXMuaXNFbXB0eSh0YXJnZXQudmFsdWUpO1xuICAgIGNvbnN0IHByZXYgPSBpIC0gMTtcblxuICAgIC8vIHByb2Nlc3Npbmcgb25seSBiYWNrc3BhY2UgZXZlbnRzXG4gICAgY29uc3QgaXNCYWNrc3BhY2VLZXkgPSBhd2FpdCB0aGlzLmlzQmFja3NwYWNlS2V5KGUpO1xuICAgIGlmICghaXNCYWNrc3BhY2VLZXkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XG5cbiAgICB0aGlzLnNldElucHV0VmFsdWUodGFyZ2V0LCBudWxsKTtcbiAgICBpZiAoIWlzVGFyZ2V0RW1wdHkpIHtcbiAgICAgIHRoaXMuZW1pdENoYW5nZXMoKTtcbiAgICB9XG5cbiAgICBpZiAocHJldiA8IDApIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoaXNUYXJnZXRFbXB0eSB8fCB0aGlzLmlzUHJldkZvY3VzYWJsZUFmdGVyQ2xlYXJpbmcpIHtcbiAgICAgIHRoaXMuaW5wdXRzW3ByZXZdLmZvY3VzKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBvbklucHV0Q29kZUNoYW5nZXMoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLmlucHV0cy5sZW5ndGgpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5pc0VtcHR5KHRoaXMuY29kZSkpIHtcbiAgICAgIHRoaXMuaW5wdXRzLmZvckVhY2goKGlucHV0OiBIVE1MSW5wdXRFbGVtZW50KSA9PiB7XG4gICAgICAgIHRoaXMuc2V0SW5wdXRWYWx1ZShpbnB1dCwgbnVsbCk7XG4gICAgICB9KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tbm9uLW51bGwtYXNzZXJ0aW9uXG4gICAgY29uc3QgY2hhcnMgPSB0aGlzLmNvZGUhLnRvU3RyaW5nKCkudHJpbSgpLnNwbGl0KCcnKTtcbiAgICAvLyBjaGVja2luZyBpZiBhbGwgdGhlIHZhbHVlcyBhcmUgY29ycmVjdFxuICAgIGxldCBpc0FsbENoYXJzQXJlQWxsb3dlZCA9IHRydWU7XG4gICAgZm9yIChjb25zdCBjaGFyIG9mIGNoYXJzKSB7XG4gICAgICBpZiAoIXRoaXMuY2FuSW5wdXRWYWx1ZShjaGFyKSkge1xuICAgICAgICBpc0FsbENoYXJzQXJlQWxsb3dlZCA9IGZhbHNlO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLmlucHV0cy5mb3JFYWNoKChpbnB1dDogSFRNTElucHV0RWxlbWVudCwgaW5kZXg6IG51bWJlcikgPT4ge1xuICAgICAgY29uc3QgdmFsdWUgPSBpc0FsbENoYXJzQXJlQWxsb3dlZCA/IGNoYXJzW2luZGV4XSA6IG51bGw7XG4gICAgICB0aGlzLnNldElucHV0VmFsdWUoaW5wdXQsIHZhbHVlKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZm9jdXNPbklucHV0QWZ0ZXJBcHBlYXJpbmcoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLnN0YXRlLmlzSW5pdGlhbEZvY3VzRmllbGRFbmFibGVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuc3RhdGUuaXNGb2N1c2luZ0FmdGVyQXBwZWFyaW5nQ29tcGxldGVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLW5vbi1udWxsLWFzc2VydGlvblxuICAgIHRoaXMuZm9jdXNPbkZpZWxkKHRoaXMuaW5pdGlhbEZvY3VzRmllbGQhKTtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tbm9uLW51bGwtYXNzZXJ0aW9uXG4gICAgdGhpcy5zdGF0ZS5pc0ZvY3VzaW5nQWZ0ZXJBcHBlYXJpbmdDb21wbGV0ZWQgPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50ID09PSB0aGlzLmlucHV0c1t0aGlzLmluaXRpYWxGb2N1c0ZpZWxkIV07XG4gIH1cblxuICBwcml2YXRlIGVtaXRDaGFuZ2VzKCk6IHZvaWQge1xuICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5lbWl0Q29kZSgpLCA1MCk7XG4gIH1cblxuICBwcml2YXRlIGVtaXRDb2RlKCk6IHZvaWQge1xuICAgIGNvbnN0IGNvZGUgPSB0aGlzLmdldEN1cnJlbnRGaWxsZWRDb2RlKCk7XG5cbiAgICB0aGlzLmNvZGVDaGFuZ2VkLmVtaXQoY29kZSk7XG5cbiAgICBpZiAoY29kZS5sZW5ndGggPj0gdGhpcy5fY29kZUxlbmd0aCkge1xuICAgICAgdGhpcy5jb2RlQ29tcGxldGVkLmVtaXQoY29kZSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRDdXJyZW50RmlsbGVkQ29kZSgpOiBzdHJpbmcge1xuICAgIGxldCBjb2RlID0gJyc7XG5cbiAgICBmb3IgKGNvbnN0IGlucHV0IG9mIHRoaXMuaW5wdXRzKSB7XG4gICAgICBpZiAoIXRoaXMuaXNFbXB0eShpbnB1dC52YWx1ZSkpIHtcbiAgICAgICAgY29kZSArPSBpbnB1dC52YWx1ZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gY29kZTtcbiAgfVxuXG4gIHByaXZhdGUgaXNCYWNrc3BhY2VLZXkoZTogYW55KTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3QgaXNCYWNrc3BhY2UgPSAoZS5rZXkgJiYgZS5rZXkudG9Mb3dlckNhc2UoKSA9PT0gJ2JhY2tzcGFjZScpIHx8IChlLmtleUNvZGUgJiYgZS5rZXlDb2RlID09PSA4KTtcbiAgICBpZiAoaXNCYWNrc3BhY2UpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodHJ1ZSk7XG4gICAgfVxuXG4gICAgLy8gcHJvY2VzcyBvbmx5IGtleSB3aXRoIHBsYWNlaG9sZGVyIGtleWNvZGUgb24gYW5kcm9pZCBkZXZpY2VzXG4gICAgaWYgKCFlLmtleUNvZGUgfHwgZS5rZXlDb2RlICE9PSAyMjkpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoZmFsc2UpO1xuICAgIH1cblxuICAgIHJldHVybiBuZXcgUHJvbWlzZTxib29sZWFuPigocmVzb2x2ZSkgPT4ge1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIGNvbnN0IGlucHV0ID0gZS50YXJnZXQ7XG4gICAgICAgIGNvbnN0IGlzUmVzZXQgPSB0aGlzLmdldFN0YXRlRm9ySW5wdXQoaW5wdXQpID09PSBJbnB1dFN0YXRlLnJlc2V0O1xuICAgICAgICBpZiAoaXNSZXNldCkge1xuICAgICAgICAgIHRoaXMuc2V0U3RhdGVGb3JJbnB1dChpbnB1dCwgSW5wdXRTdGF0ZS5yZWFkeSk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gaWYgYmFja3NwYWNlIGtleSBwcmVzc2VkIHRoZSBjYXJldCB3aWxsIGhhdmUgcG9zaXRpb24gMCAoZm9yIHNpbmdsZSB2YWx1ZSBmaWVsZClcbiAgICAgICAgcmVzb2x2ZShpbnB1dC5zZWxlY3Rpb25TdGFydCA9PT0gMCAmJiAhaXNSZXNldCk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0SW5wdXRWYWx1ZShpbnB1dDogSFRNTElucHV0RWxlbWVudCwgdmFsdWU6IGFueSk6IHZvaWQge1xuICAgIGNvbnN0IGlzRW1wdHkgPSB0aGlzLmlzRW1wdHkodmFsdWUpO1xuICAgIGNvbnN0IHZhbHVlQ2xhc3NDU1MgPSAnaGFzLXZhbHVlJztcbiAgICBjb25zdCBlbXB0eUNsYXNzQ1NTID0gJ2VtcHR5JztcbiAgICBpZiAoaXNFbXB0eSkge1xuICAgICAgaW5wdXQudmFsdWUgPSAnJztcbiAgICAgIGlucHV0LmNsYXNzTGlzdC5yZW1vdmUodmFsdWVDbGFzc0NTUyk7XG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tbm9uLW51bGwtYXNzZXJ0aW9uXG4gICAgICBpbnB1dC5wYXJlbnRFbGVtZW50IS5jbGFzc0xpc3QuYWRkKGVtcHR5Q2xhc3NDU1MpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIGlucHV0LnZhbHVlID0gdmFsdWU7XG4gICAgICBpbnB1dC5jbGFzc0xpc3QuYWRkKHZhbHVlQ2xhc3NDU1MpO1xuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLW5vbi1udWxsLWFzc2VydGlvblxuICAgICAgaW5wdXQucGFyZW50RWxlbWVudCEuY2xhc3NMaXN0LnJlbW92ZShlbXB0eUNsYXNzQ1NTKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNhbklucHV0VmFsdWUodmFsdWU6IGFueSk6IGJvb2xlYW4ge1xuICAgIGlmICh0aGlzLmlzRW1wdHkodmFsdWUpKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgY29uc3QgaXNEaWdpdHNWYWx1ZSA9IC9eWzAtOV0rJC8udGVzdCh2YWx1ZS50b1N0cmluZygpKTtcbiAgICByZXR1cm4gaXNEaWdpdHNWYWx1ZSB8fCAodGhpcy5pc0NoYXJzQ29kZSB8fCB0aGlzLmlzTm9uRGlnaXRzQ29kZSk7XG4gIH1cblxuICBwcml2YXRlIHNldFN0YXRlRm9ySW5wdXQoaW5wdXQ6IEhUTUxJbnB1dEVsZW1lbnQsIHN0YXRlOiBJbnB1dFN0YXRlKTogdm9pZCB7XG4gICAgY29uc3QgaW5kZXggPSB0aGlzLmlucHV0cy5pbmRleE9mKGlucHV0KTtcbiAgICBpZiAoaW5kZXggPCAwKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5pbnB1dHNTdGF0ZXNbaW5kZXhdID0gc3RhdGU7XG4gIH1cblxuICBwcml2YXRlIGdldFN0YXRlRm9ySW5wdXQoaW5wdXQ6IEhUTUxJbnB1dEVsZW1lbnQpOiBJbnB1dFN0YXRlIHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCBpbmRleCA9IHRoaXMuaW5wdXRzLmluZGV4T2YoaW5wdXQpO1xuICAgIHJldHVybiB0aGlzLmlucHV0c1N0YXRlc1tpbmRleF07XG4gIH1cblxuICBwcml2YXRlIGlzRW1wdHkodmFsdWU6IGFueSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAgdmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCB8fCAhdmFsdWUudG9TdHJpbmcoKS5sZW5ndGg7XG4gIH1cbn1cbiJdfQ==